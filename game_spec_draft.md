# 運要素のないモンスターゲーム仕様ドラフト

## 概要
モンスターのターン制バトルゲームを開発するが、運要素（ランダム性）を完全に排除し、戦略性と計算に基づいた戦闘を実現する。プレイヤーは**3体のパーティ**を編成し、技や交代を駆使して相手を倒す。すべてのダメージ計算は固定の数式で行われ、タイプ相性、ステータス、行動順が勝敗を決定する。

## ゲームルール
- **パーティ制**: プレイヤーと相手はそれぞれ3体のモンスターでパーティを編成。
- **ターン制バトル**: 2フェーズ制
  1. **行動選択フェーズ**: 両プレイヤーが同時に技または交代を選択
  2. **実行フェーズ**: 選択後、以下の順序で処理
     - 交代処理（素早さが高い順）
     - 技処理（優先度が高い順 → 同優先度は素早さが高い順）
     - 状態異常処理（将来的拡張）
- **モンスター**: 各モンスターにはHP、攻撃力、防御力、素早さ、タイプ（火、水、草）が設定。
- **技**: 各技には威力、タイプ、優先度が設定。ダメージは固定計算式。
- **タイプ相性**: 固定の相性表（水 > 火 = 2倍、火 < 水 = 0.5倍など）。
- **勝利条件**: 相手の全モンスター（3体）のHPを0にする。
- **運要素なし**: クリティカルヒット、回避、乱数ダメージなし。すべて予測可能。

## システム要件
- **プラットフォーム**: Webブラウザ（PC/モバイル対応予定）。
- **ユーザー**: 1人（AI対戦）、将来的に2人（対人戦）。
- **データ**: モンスターは事前定義（現在6体、拡張可能）。
- **バトルシステム**: パーティ制（3体）、2フェーズターン制、素早さベース行動順。

## 技術スタック（実装済み）
- **フロントエンド**: Nuxt.js (Vue.js 3、Composition API)。
- **バックエンド**: Node.js + Express.js (REST API)。
- **データベース**: MongoDB (Mongoose ORM、Docker環境)。
- **その他**: 将来的にSocket.io（リアルタイム対人戦用）。

## 機能リスト（実装状況）
- **モンスター選択画面**: ✅ 利用可能なモンスター一覧から**プレイヤー3体、相手3体**を選択。
- **バトル画面**: ✅ 実装済み
  - パーティ3体の表示（プレイヤー/相手）
  - 現在戦闘中のモンスターをハイライト
  - HPバー、技選択ボタン、交代ボタン
  - バトルログ表示
  - ひんし時の強制交代モーダル
- **ダメージ計算**: ✅ バックエンドで計算し、フロントに結果送信。
- **行動順制御**: ✅ 素早さと優先度による行動順ソート実装。
- **勝敗判定**: ✅ パーティ全滅時の勝敗判定・結果表示。
- **AI対戦**: ✅ 自動で行動選択（現在はランダム、将来的に戦略的AI）。
- **2フェーズターン制**: ✅ 行動選択 → 実行の流れ実装済み。
- **ユーザープロフィール**: ⏳ 勝敗記録保存（将来的拡張）。

## 実装計画（進捗）
1. **プロジェクトセットアップ**: ✅ Nuxt.jsプロジェクト、Node.jsバックエンド構築完了。
2. **モンスター定義**: ✅ MongoDBでモンスター/技データ定義（6体実装）。
3. **バトルロジック実装**: ✅ ダメージ計算、素早さ順ソート、ターン処理完了。
4. **フロントエンドUI**: ✅ バトル画面、選択画面作成（パーティ制対応）。
5. **API統合**: ✅ フロントとバックエンド接続完了。
6. **テスト**: 🚧 バトルシミュレーション、UIテスト（デバッグ中）。
7. **拡張**: ⏳ 対人戦（WebSocket）、戦略的AI、新モンスター追加など。

## 考慮点
- **バランス調整**: タイプ相性とステータス（特に素早さ）で戦略性を確保。
- **拡張性**: 
  - 新モンスター/技の追加容易（seedMonsters.js更新）
  - パーティ数変更可能（3体 → 4体以上）
  - 特性・持ち物システムの追加余地あり
- **パフォーマンス**: 計算は軽量、Populate使用でDBクエリ最適化済み。
- **セキュリティ**: 対人戦時はチート防止（全計算バックエンド実行）。
- **戦略性**: 
  - 技の優先度による先制攻撃
  - 素早さによる行動順決定
  - 交代による有利タイプへの切り替え
  - パーティ編成の重要性（タイプバランス）

## 現在の課題
- **デバッグ**: POST /api/battle/:battleId/action の500エラー対応中
  - 原因調査: move.id と selectedAction.moveId のマッチング
  - Populate処理の検証
  - 詳細ログで実行フロー追跡中

このドラフトは実装状況を反映し、今後の開発方針を示す。